<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Mikosell Pro</title>
<style>
body { font-family:'Poppins',sans-serif; background:#1a1a2e; color:#fff; padding:20px; }
h2 { color:#ffcc00; text-align:center; margin-bottom:20px; }
.deposit { background: rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin-bottom:15px; }
.deposit button { padding:5px 10px; background:#ffcc00; border:none; border-radius:5px; cursor:pointer; margin-top:5px; }
.deposit button:hover { background:#ff9900; }
.success { color:#00ff99; margin-top:5px; }
</style>
</head>
<body>
<h2>Demandes de dépôt</h2>
<div id="deposits"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKyAIcBC8tpWWaYgE_NeZEWJn8AEoyDLQ",
  authDomain: "valide-28624.firebaseapp.com",
  projectId: "valide-28624",
  storageBucket: "valide-28624.firebasestorage.app",
  messagingSenderId: "483447990733",
  appId: "1:483447990733:web:ee5b850dc31cbb8776bc84",
  measurementId: "G-BSZJ5PW639"
};
firebase.initializeApp(firebaseConfig);
const analytics = firebase.analytics();
const db = firebase.firestore();

function loadDeposits() {
  db.collection("deposits").where("status","==","pending")
    .orderBy("date","desc")
    .onSnapshot(snapshot => {
      const container = document.getElementById('deposits');
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const div = document.createElement('div');
        div.className="deposit";
        div.innerHTML = `
          <p><strong>${d.userEmail}</strong> demande <strong>${d.amount} FCFA</strong> (${d.network})</p>
          <p>Message: ${d.message}</p>
          <button onclick="approve('${doc.id}', ${d.amount}, '${d.userEmail}', this)">Approuver</button>
          <div class="success" style="display:none;">✅ Dépôt approuvé !</div>
        `;
        container.appendChild(div);
      });
    });
}

function approve(id, amount, email, btn) {
  const successEl = btn.nextElementSibling;

  // Ajoute le solde de l'utilisateur
  const userRef = db.collection("users").doc(email);
  userRef.get().then(doc => {
    if (doc.exists) {
      userRef.update({ balance: (doc.data().balance || 0) + amount });
    } else {
      userRef.set({ balance: amount });
    }
  });

  // Marque la demande comme approuvée
  db.collection("deposits").doc(id).update({ status: "approved" }).then(() => {
    successEl.style.display = "block";  // Affiche ✅ Dépôt approuvé
    btn.style.display = "none";         // Masque le bouton
  }).catch(err => console.error(err));
}

loadDeposits();
</script>
</body>
</html>
